



由于 JS 是单线程并发语言，其中的并发就是通过事件循环与任务队列的方式实现了。宏观上，这种方案类似于计算机如何实现多线程的。

1. 要想理解宏观队列与微观队列，首先要明白什么是队列？即任务队列与事件循环这两个概念。不只是概念，还有实现方式。
2. 宏观队列和微观队列可以说是任务队列和事件机制的具体实现方式。  那么具体是怎么实现的？又有什么影响呢？
3. 由此。再看宏观队列和微观队列的概念，是什么意思？
4. 

事件循环与任务队列是 JS 中比较重要的两个概念。这两个概念在ES5 和 ES6 两个标准中*有不同的实现方式*





>  JS 是单线程并发语言，单线程事件循环是并发的一种形式。队列则是配合事件循环完成操作的，一个单线程可以拥有多个任务队列。最终以多个队列的形式实现单线程的并发能力。

**关键字：单线程、并发、事件、事件循环、任务队列（宏观队列、微观队列）。**





### JavaScript 事件循环

这个时间模型图，描述了宏观上，JavaScript的时间执行流程与模块划分。（*这个图和内存图类似，有什么联系呢？*）

![1554186615680](F:\Gumx Cloud\Git Repositories\hexo-pages\source\_posts\前端\JS\imgs\1554186615680.png)

* 函数调用栈 ：基于主线程任务的执行。
* 浏览器APIs：用于执行浏览器API等异步操作。
* 任务队列（Queue）：用于存放处理完成，待执行的异步任务和定时任务等。



JavaScript代码的执行机制：

- 所有同步任务都在主线程上的栈中执行。
- 主线程之外，还存在一个"任务队列"（task queue）。**只要异步任务有了运行结果**，就在"任务队列"之中放置一个事件。
- 一旦"栈"中的所有同步任务执行完毕，系统就会读取"任务队列"，选择出需要首先执行的任务（由浏览器决定，并不按序）。



**从队列的角度看：**

宏观的执行逻辑是：在主线程上优先执行所有的同步任务，当同步任务执行完成后，此时如果异步任务队列中有已完成的异步事件需要执行，则开始执行这些队列 里的事件。

**从事件循环的角度看**

即主线程在循环的执行这么一个逻辑：

![1554187303417](F:\Gumx Cloud\Git Repositories\hexo-pages\source\_posts\前端\JS\imgs\1554187303417.png)





可以说，这就是宏观的事件循环机制。也是宏观的队列机制。这也就称为**事件循环**



`ES6`标准中任务队列存在两种类型，一种就是上边提到的一些队列，比如`setTimeout`、网络请求`Ajax`、用户`I\O`等都属于宏观任务队列（microtask queue），另一种是微观任务队列（macrotask queue），`Promise`就属于微观任务队列。
  添加了微观任务队列之后事件循环有什么变化呢？在执行栈执行的过程中会把属于微观任务队列的任务分配到相应的**微观任务队列**中去。而在调用栈执行空之后，主线程读取任务队列时，会先读取**所有微观任务队列**，然后读取**一个宏观任务队列**，**再读取所有的微观任务队列**。



![1554188054685](F:\Gumx Cloud\Git Repositories\hexo-pages\source\_posts\前端\JS\imgs\1554188054685.png)



### 任务



* 每个浏览器环境最多有一个 event loop。
* 一个 event loop 可以有一个或者多个 task queue，而仅有一个 MicroTask Queue。
* 一个 task queue 是一列有序的task，每个task定义时都有一个task source，从同一个task source来的task必须放到同一个task queue，从不同源来的则被添加到不同队列。

- tasks are scheduled，所以浏览器可以从内部到JS/DOM，保证动作按序发生。
- Microtasks are scheduled，Microtask queue 在当前 task queue 的结尾执行。microtask中添加的microtask也被添加到Microtask queue的末尾并处理。

**注：** event loop的每个turn，是由浏览器决定先执行哪个task queue。这允许浏览器为不同的task source设置不同的优先级，比如为用户交互设置更高优先级来使用户感觉流畅。











https://juejin.im/search?query=%E5%AE%8F%E8%A7%82%E9%98%9F%E5%88%97%20js&type

https://juejin.im/entry/59f9caa46fb9a045132a051b

https://juejin.im/post/5bdec7d551882516ce4e4d10

https://www.cnblogs.com/yzg1/p/7514514.html